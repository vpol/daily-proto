version: 2.1

defaults: &defaults
  working_directory: /tmp/workflows

jobs:

  sync:
    <<: *defaults

    docker:
      - image: docker.io/vpol/daily-proto-docker-runner:latest

    steps:
      - run: | 
          echo "sync"

  lint-python:

    <<: *defaults

    docker:
      - image: docker.io/vpol/daily-proto-docker-runner:latest

    steps:
      - checkout
      - run: |
          python /build.py python .
      - run: |
          echo $CIRCLE_TAG
          echo $CIRCLE_SHA1

  push-python:
    <<: *defaults

    docker:
      - image: docker.io/vpol/daily-proto-docker-runner:latest

    steps:
      - checkout
      - run: |
          git push --set-upstream origin main
          git config credential.helper 'cache --timeout=120'
          git config user.email "vpoluksht@gmail.com"
          git config user.name "Viktor Poluksht"
      - run: |
          mkdir -p github.com/vpol/daily-proto-python
          cd github.com/vpol/
          git clone https://${REPO_USER}:${REPO_TOKEN}@github.com/vpol/daily-proto-python
          find ./daily-proto-python -type d -not -path './daily-proto-python/.git*' -not -path './daily-proto-python' | xargs rm  -rf {}
          cd ../..
          python /build.py python .
      - run: |
          git add .
          git commit --allow-empty -m "${CIRCLE_SHA1}: protobuf update"
          git tag 'dev-${CIRCLE_SHA1}'
          git push -q https://${REPO_USER}:${REPO_TOKEN}@github.com/vpol/daily-proto-python --tags

  tag-python:

    <<: *defaults

    docker:
      - image: docker.io/vpol/daily-proto-docker-runner:latest

    steps:
      - run: |
          echo "tag-python"

  lint-go:

    <<: *defaults

    docker:
      - image: docker.io/vpol/daily-proto-docker-runner:latest

    steps:
      - checkout
      - run: |
          python /build.py go .

  push-go:
    <<: *defaults

    docker:
      - image: docker.io/vpol/daily-proto-docker-runner:latest

    steps:
      - checkout
      - run: |
          git push --set-upstream origin main
          git config credential.helper 'cache --timeout=120'
          git config user.email "vpoluksht@gmail.com"
          git config user.name "Viktor Poluksht"
      - run: |
          mkdir -p github.com/vpol/daily-proto-go
          cd github.com/vpol/
          git clone https://${REPO_USER}:${REPO_TOKEN}@github.com/vpol/daily-proto-go
          find ./daily-proto-go -type d -not -path './daily-proto-go/.git*' -not -path './daily-proto-go' -not -path './daily-proto-go/go.mod' -not -path './daily-proto-go/go.sum' | xargs rm  -rf {}
          cd ../..
          python /build.py go .
      - run: |
          git add .
          git commit --allow-empty -m "${CIRCLE_SHA1}: protobuf update"
          git tag 'dev-$CIRCLE_SHA1'
          git push -q https://${REPO_USER}:${REPO_TOKEN}@github.com/vpol/daily-proto-go --tags

  tag-go:

    <<: *defaults

    docker:
      - image: docker.io/vpol/daily-proto-docker-runner:latest

    steps:
      - run: |
          echo "tag-go"

  lint-ts:

    <<: *defaults

    docker:
      - image: docker.io/vpol/daily-proto-docker-runner:latest

    steps:
      - checkout
      - run: |
          python /build.py ts .


  push-ts:
    <<: *defaults

    docker:
      - image: docker.io/vpol/daily-proto-docker-runner:latest

    steps:
      - checkout
      - run: |
          git push --set-upstream origin main
          git config credential.helper 'cache --timeout=120'
          git config user.email "vpoluksht@gmail.com"
          git config user.name "Viktor Poluksht"
      - run: |
          mkdir -p github.com/vpol/daily-proto-ts
          cd github.com/vpol/
          git clone https://${REPO_USER}:${REPO_TOKEN}@github.com/vpol/daily-proto-ts
          cd ../..
          python /build.py ts .
      - run: |
          git add .
          git commit --allow-empty -m "${CIRCLE_SHA1}: protobuf update"
          git tag 'dev-$CIRCLE_SHA1'
          git push -q https://${REPO_USER}:${REPO_TOKEN}@github.com/vpol/daily-proto-ts --tags

  tag-ts:

    <<: *defaults

    docker:
      - image: docker.io/vpol/daily-proto-docker-runner:latest

    steps:
      - run: |
          echo "tag-ts"

workflows:

  build-and-update:

    jobs:

      - lint-go

      - push-go:
          context: GCR
          requires:
            - lint-go

      - lint-python

      - push-python:
          context: GCR
          requires:
            - lint-python

      - lint-ts

      - push-ts:
          context: GCR
          requires:
            - lint-ts

      - sync:
          requires:
            - push-go
            - push-python
            - push-ts

      - tag-go:
          context: GCR
          requires:
            - sync
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore: /.*/

      - tag-python:
          context: GCR
          requires:
            - sync
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore: /.*/

      - tag-ts:
          context: GCR
          requires:
            - sync
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore: /.*/

